var routeApp=angular.module("index",["ui.router","ui.bootstrap","ngAnimate","ngTouch","infinite-scroll"]),host="http://www.bookist.org";routeApp.config(["$stateProvider","$locationProvider","$httpProvider","$urlRouterProvider",function(t,e,o,s){o.defaults.transformResponse.push(function(t){if("undefined"!=typeof t.data){if("error"!=t.status)return t=t.data;alert(t.message),window.location.reload()}return t}),o.interceptors.push("timestampMarker"),o.interceptors.push("tokenInjector"),s.otherwise("/"),t.state("index",{url:"/",templateUrl:"index/index_tpl.html",controller:"IndexCtrl"}).state("recommend",{url:"/books/recommend",controller:"RecommendMoreCtrl",templateUrl:"recommend_more/recommend_more_tpl.html"}).state("booklists",{url:"/booklists",controller:"BooklistsCtrl",templateUrl:"booklists/booklists_tpl.html"}).state("popular",{url:"/booklists/popular",controller:"PopularMoreCtrl",templateUrl:"popular_more/popular_more_tpl.html"}).state("book",{url:"/book/{isbn}",controller:"BookCtrl",templateUrl:"book/book_tpl.html"}).state("bookDetail",{url:"/book/{isbn}/detail",controller:"BookInfoCtrl",templateUrl:"book_info/book_info_tpl.html"}).state("booklist",{url:"/booklist/{id}",controller:"BookListCtrl",templateUrl:"booklist/booklist_tpl.html"}).state("tagBooklists",{url:"/booklists/{tag}",controller:"TagBooklistsCtrl",templateUrl:"tag-booklists/tag-booklists_tpl.html"}).state("commentsBook",{url:"/comments/{isbn}",controller:"CommentsCtrl",templateUrl:"comments/comments_tpl.html"}).state("tags",{url:"/tags",controller:"TagsCtrl",templateUrl:"tags/tags_tpl.html"}).state("me",{url:"/me",controller:"MeCtrl",templateUrl:"me/me_tpl.html"}).state("ordersWait",{url:"/orders/wait",controller:"OrdersWaitCtrl",templateUrl:"orders_wait/orders_wait_tpl.html"}).state("cart",{url:"/cart",controller:"CartCtrl",templateUrl:"cart/cart_tpl.html"}).state("ordersReceived",{url:"/orders/received",controller:"OrdersReceivedCtrl",templateUrl:"orders_received/orders_received_tpl.html"}).state("orders",{url:"/orders",controller:"OrdersCtrl",templateUrl:" app/module/orders/orders_tpl.html"}).state("orderDetail",{url:"/order/{id}/detail",controller:"OrderDetailCtrl",templateUrl:"order_detail/order_detail_tpl.html"}).state("orderComments",{url:"/order/{id}/comments",controller:"OrderCommentsCtrl",templateUrl:"order_comments/order_comments_tpl.html"}).state("comments",{url:"/comments",controller:"UserCommentsCtrl",templateUrl:"user_comments/user_comments_tpl.html"}).state("booklistsCollect",{url:"/collect/booklists",controller:"CollectBookListsCtrl",templateUrl:"collect_booklists/collect_booklists_tpl.html"}).state("booksCollect",{url:"/collect/books",controller:"CollectBooksCtrl",templateUrl:"collect_books/collect_books_tpl.html"}).state("point",{url:"/point",controller:"PointCtrl",templateUrl:"point/point_tpl.html"}).state("notices",{url:"/notices",controller:"NoticesCtrl",templateUrl:"notices/notices_tpl.html"}).state("settings",{url:"/settings",controller:"SettingsCtrl",templateUrl:"settings/settings_tpl.html"}).state("signature",{url:"/setting/signature/{signature}",controller:"SignatureCtrl",templateUrl:"setting_signature/setting_signature_tpl.html"}).state("address",{url:"/setting/address",controller:"AddressCtrl",templateUrl:"setting_address/setting_address_tpl.html"}).state("AddressAdd",{url:"/setting/address/add",controller:"AddressAddCtrl",templateUrl:"setting_address_add/setting_address_add_tpl.html"})}]),routeApp.directive("currentTime",["$timeout","dateFilter",function(t,e){return{scope:{format:"@",real:"@"},link:function(o,s){function r(){s.text(e(new Date,o.format))}function n(){l=t(function(){r(),n()},1e3)}var l;"true"==o.real||o.real?(s.bind("$destroy",function(){t.cancel(l)}),n()):r()}}}]),routeApp.directive("focusMe",["$timeout",function(t){return{scope:{trigger:"@focusMe"},link:function(e,o){e.$watch("trigger",function(e){"true"===e&&t(function(){o[0].focus()})})}}}]),routeApp.directive("navbar",function(){return{restrict:"AE",replace:!0,templateUrl:"navbar/navbar_tpl.html"}}),routeApp.directive("loading",function(){return{restrict:"AE",replace:!0,template:'<div class="cssload-container"><div class="cssload-cord cssload-leftMove"><div class="cssload-ball"></div></div><div class="cssload-cord"<div class="cssload-ball"></div</div<div class="cssload-cord"> <div class="cssload-ball"></div> </div> <div class="cssload-cord"> <div class="cssload-ball"></div> </div> <div class="cssload-cord"> <div class="cssload-ball"></div> </div> <div class="cssload-cord"> <div class="cssload-ball"></div> </div> <div class="cssload-cord cssload-rightMove"> <div class="cssload-ball"></div> </div> <div class="cssload-shadows"> <div class="cssload-leftShadow"></div> <div></div> <div></div> <div></div> <div></div> <div></div> <div class="cssload-rightShadow"></div> </div>'}}),routeApp.directive("myMaxlength",function(){return{require:"ngModel",link:function(t,e,o,s){function r(t){if(t.length>n){var e=t.substring(0,n);return s.$setViewValue(e),s.$render(),e}return t}var n=Number(o.myMaxlength);s.$parsers.push(r)}}}),routeApp.factory("BL",["$http",function(t){var e=function(t,e){this.list=[],this.busy=!1,this.url=t,this.params=e,this["continue"]=!0};return e.prototype.nextPage=function(){return this["continue"]?void(this.busy||(this.busy=!0,t({method:"GET",url:this.url,params:this.params}).success(function(t){var e=t;e.length<5&&(this["continue"]=!1);for(var o=0;o<e.length;o++)e[o].star=Math.ceil(e[o].rate/2),this.list.push(e[o]);this.busy=!1,this.params.page+=1}.bind(this)))):void(this.busy=!1)},e}]),routeApp.factory("UserMessage",function(){var t=[],e="",o={};return{getAddress:function(){return t},getSignature:function(){return e},getTemp:function(){return o},setAddress:function(e){t=e},setSignature:function(t){e=t},setTemp:function(t){o=t}}}),routeApp.factory("timestampMarker",[function(){var t={request:function(t){return t.requestTimestamp=(new Date).getTime(),t},response:function(t){return t.config.responseTimestamp=(new Date).getTime(),t}};return t}]),routeApp.factory("tokenInjector",["$injector","$q","$location",function(t,e){var o={request:function(o){var s=host+"/auth_verify",r=e.defer(),n=t.get("$http");if(o.url===s)return o;if("true"===sessionStorage.verify){var l=(new Date).getTime();l-sessionStorage.createdtime>=7e3&&(sessionStorage.verify=!1),r.resolve(o)}else n({method:"GET",url:s,params:{token:sessionStorage.token,user_id:sessionStorage.user_id}}).success(function(t){sessionStorage.token=t.token,sessionStorage.createdtime=t.time,sessionStorage.verify="true",o.headers.token=sessionStorage.token,o.headers.userid=sessionStorage.user_id,r.resolve(o)}).error(function(){console.log("verify error"),window.location.replace(host),r.resolve(o)});return r.promise}};return o}]),routeApp.controller("BookCtrl",["$scope","$http","$stateParams",function(t,e,o){t.more=!1,t.commentBox=!1,t.auth=!0,t.busy=!0,e({method:"GET",url:host+"/book",params:{isbn:o.isbn}}).success(function(e){t.book=e,t.book.star=Math.ceil(e.rate/2),t.busy=!1}),e({method:"GET",url:host+"/user"}).success(function(e){t.user=e,t.auth=!0}),t.collect=function(){e({method:"POST",url:host+"/collect",data:{isbn:o.isbn}}).success(function(){t.book.collected=!t.book.collected})},e({method:"GET",url:host+"/book",params:{isbn:o.isbn,type:"similarity"}}).success(function(e){t.booksBought=e.books;for(var o=0;o<t.booksBought.length;o++)t.booksBought[o].star=Math.ceil(t.booksBought[o].rate/2)}),e({method:"GET",url:host+"/booklist",params:{isbn:o.isbn}}).success(function(e){t.booklists=e}),t.up=function(t){e({method:"POST",url:host+"/comment",data:{id:t.id,action:"up"}}).success(function(){t.up_already=!t.up_already,t.down_already=!1,t.up=response.up,t.down=response.down})},t.down=function(t){t.down_already=!t.down_already,t.up_already=!1,e({method:"POST",url:host+"/comment",data:{id:t.id,action:"down"}}).success(function(){t.down_already=!t.down_already,t.up_already=!1,t.up=response.up,t.down=response.down})},t.hoveringOver=function(e){t.overStar=e}}]),routeApp.controller("BookListCtrl",["$scope","$http","$stateParams",function(t,e,o){t.busy=!0,e({method:"GET",url:host+"/user"}).success(function(e){t.user=e}),e({method:"GET",url:host+"/booklist",params:{id:o.id}}).success(function(e){t.booklist=e;for(var o=0;o<t.booklist.books.length;o++)t.booklist.books[o].star=Math.ceil(t.booklist.books[o].rate/2);t.busy=!1}),t.collect=function(){e({method:"POST",url:host+"/collect",data:{type:"booklist",id:o.id}}).success(function(){t.booklist.collect_already=!t.booklist.collect_already})}}]),routeApp.controller("BooklistsCtrl",["$scope","$http","BL",function(t,e,o){e({method:"GET",url:host+"/tags",params:{type:"hot"}}).success(function(e){t.tags=e});var s=host+"/booklist",r={type:"all",page:1};t.booklists=new o(s,r),t.timeOrder=function(){var e=host+"/booklist",s={type:"time",page:1};t.booklists=new o(e,s),t.booklists.nextPage()},t.collectOrder=function(){var e=host+"/booklist",s={type:"collect",page:1};t.booklists=new o(e,s),t.booklists.nextPage()}}]),routeApp.controller("BookInfoCtrl",["$http","$scope","$stateParams",function(t,e,o){e.busy=!0,t({method:"GET",url:host+"/book",params:{isbn:o.isbn,type:"detail"}}).success(function(t){e.book=t,e.busy=!1})}]),routeApp.controller("CartCtrl",["$scope","$http",function(t,e){t.price=0,t.busy=!0,e({method:"GET",url:host+"/cart"}).success(function(e){t.items=e,t.busy=!1,t.recount(t.items)}),t.recount=function(){t.price=0;for(var e=0;e<t.items.length;e++)t.items[e].removed=!1,t.price+=t.items[e].price*t.items[e].count;0==t.items.length&&(t.message=!0)},t.removeBook=function(o,s){e({method:"DELETE",url:host+"/cart_todo",data:{isbn:o.isbn}}).success(function(){t.items.splice(s,1),t.recount()})},t.editBook=function(o){o.count<=0&&(o.count=1),o.count>10&&(o.count=10),e({method:"PUT",url:host+"/cart_todo",data:{isbn:o.isbn,count:o.count}}).success(function(){t.recount()})},t.mark=function(o,s){e({method:"POST",url:host+"/collect",data:{isbn:o.isbn}}).success(function(){t.removeBook(o,s)})}}]),routeApp.controller("CollectBookListsCtrl",["$http","$scope",function(t,e){e.busy=!0,t({method:"GET",url:host+"/collect",params:{type:"booklist"}}).success(function(t){e.booklists=t,e.busy=!1})}]),routeApp.controller("CollectBooksCtrl",["$http","$scope","BL",function(t,e,o){e.busy=!0,t({method:"GET",url:host+"/collect",params:{type:"book"}}).success(function(t){e.books=t;for(var o=0;o<e.books.length;o++)e.books[o].star=Math.ceil(e.books[o].rate/2);e.busy=!1}),e.remove=function(o,s){t({method:"POST",url:host+"/collect",data:{isbn:o.isbn}}).success(function(){e.books.splice(s,1)})}}]),routeApp.controller("CommentsCtrl",["$scope","$http","$stateParams",function(t,e,o){t.busy=!0,e({method:"GET",url:host+"/comments",params:{isbn:o.isbn}}).success(function(e){t.comments=e,t.busy=!1}),t.up=function(t){e({method:"POST",url:host+"/comment",data:{id:t.id,action:"up"}}).success(function(e){t.up_already=!t.up_already,t.down_already=!1,t.up=e.up,t.down=e.down})},t.down=function(t){e({method:"POST",url:host+"/comment",data:{id:t.id,action:"down"}}).success(function(){t.down_already=!t.down_already,t.up_already=!1,t.up=response.up,t.down=response.down})}}]),routeApp.controller("IndexCtrl",["$scope","$http",function(t,e){t.myInterval=5e3,t.noWrapSlides=!1,t.active=0,e({method:"GET",url:host+"/slides"}).success(function(e){t.slides=e}),e({method:"GET",url:host+"/books",params:{}}).success(function(e){t.books=e;for(var o=0;o<t.books.length;o++)t.books[o].star=Math.ceil(t.books[o].rate/2)}),e({method:"GET",url:host+"/booklist",params:{type:"hot"}}).success(function(e){t.booklists=e})}]),routeApp.controller("MeCtrl",["$scope","$http",function(t,e){e({method:"GET",url:host+"/user"}).success(function(e){t.user=e})}]),routeApp.controller("NoticesCtrl",["$http","$scope",function(t,e){e.busy=!0,t({method:"GET",url:host+"/notices"}).success(function(t){e.notices=t,e.busy=!1})}]),routeApp.controller("OrdersCtrl",["$scope","$http",function(t,e){t.message=!1,t.busy=!0,e({method:"GET",url:host+"/orders",params:{type:"all"}}).success(function(e){t.orders=e,t.orders=e,t.busy=!1}),t.receipt=function(t){e({method:"POST",url:host+"/order",data:{id:t.id}}).success(function(){t.status="待评价"})}}]),routeApp.controller("OrdersReceivedCtrl",["$scope","$http",function(t,e){t.message=!1,t.busy=!0,e({method:"GET",url:host+"/orders",params:{type:"received"}}).success(function(e){t.orders=e,t.busy=!1})}]),routeApp.controller("OrdersWaitCtrl",["$scope","$http",function(t,e){t.busy=!0,e({method:"GET",url:host+"/orders",params:{type:"wait"}}).success(function(e){t.orders=e,t.busy=!1}),t.receipt=function(o,s){e({method:"POST",url:host+"/order",data:{id:o.id}}).success(function(){t.orders.splice(s,1)})}}]),routeApp.controller("OrderCommentsCtrl",["$scope","$http","$stateParams",function(t,e,o){t.busy=!0,e({method:"GET",url:host+"/orders",params:{id:o.id}}).success(function(e){t.order=e,t.busy=!1})}]),routeApp.controller("OrderDetailCtrl",["$scope","$http","$stateParams",function(t,e,o){t.busy=!0,e({method:"GET",url:host+"/orders",params:{id:o.id}}).success(function(e){t.order=e,t.busy=!1}),t.receipt=function(o){e({method:"POST",url:host+"/order",data:{id:o.id}}).success(function(){t.order.process.push({status:"已收货",time:"2015-04-03 12:12:00"}),t.order.status="待评价",t.turn=3})}}]),routeApp.controller("PointCtrl",["$http","$scope","BL",function(t,e,o){e.busy=!0,t({method:"GET",url:host+"/points"}).success(function(t){e.points=t,e.busy=!1}),t({method:"GET",url:host+"/user"}).success(function(t){e.user=t})}]),routeApp.controller("PopularMoreCtrl",["$scope","BL",function(t,e){var o=host+"/booklist",s={type:"hot",page:1};t.booklists=new e(o,s)}]),routeApp.controller("RecommendMoreCtrl",["$scope","BL",function(t,e){var o=host+"/book",s={type:"user",page:1};t.books=new e(o,s)}]),routeApp.controller("SettingsCtrl",["$http","$scope","UserMessage",function(t,e,o){t({method:"GET",url:host+"/user",params:{type:"detail"}}).success(function(t){e.user=t}),e.change=function(){t({method:"POST",url:host+"/user",data:{sex:e.user.sex}}).success(function(){"男"==e.user.sex?e.user.sex="女":e.user.sex="男"})},e.edit=function(){t({method:"POST",url:host+"/user",data:{name:e.user.name}}).success(function(t){})},o.setSignature(e.user.signature),o.setAddress(e.user.address)}]),routeApp.controller("AddressCtrl",["$http","$scope","$location","UserMessage",function(t,e,o,s){e.address=s.getAddress(),e["return"]=function(){o.path("/settings").replace()},e.edit=function(t){s.setTemp(this.address[t]),o.path("/setting/address/add").replace()}}]),routeApp.controller("AddressAddCtrl",["$http","$scope","$location","UserMessage",function(t,e,o,s){var r=s.getTemp();e.deleteBox=!1,null!=r&&(e.name=r.name,e.phone=r.phone,e.dorm=r.dorm,e.id=r.id,e.deleteBox=!0,s.setTemp({})),e.add=function(){t({method:"POST",url:host+"/address",data:{name:e.name,phone:e.phone,dorm:e.dorm}}).success(function(){o.path("/setting/address").replace()})},e["delete"]=function(e){t({method:"DELETE",url:host+"/address",data:{id:e}}).success(function(){o.path("/setting/address").replace()})},e["return"]=function(){o.path("/setting/address").replace()}}]),routeApp.controller("SignatureCtrl",["$http","$scope","$stateParams","$location",function(t,e,o,s){e.signature=o.signature,e.post=function(){t({method:"POST",url:host+"/signature",data:{signature:this.signature}}).success(function(){s.path("/settings").replace()})},e["return"]=function(){s.path("/settings").replace()}}]),routeApp.controller("TagBooklistsCtrl",["$scope","BL","$stateParams",function(t,e,o){var s=host+"/booklist",r={tag:o.tag,page:1};t.booklists=new e(s,r),t.timeOrder=function(){var s=host+"/booklist",r={tag:o.tag,page:1,type:"time"};t.booklists=new e(s,r),t.booklists.nextPage()},t.collectOrder=function(){var s=host+"/booklist",r={tag:o.tag,page:1,type:"collect"};t.booklists=new e(s,r),t.booklists.nextPage()}}]),routeApp.controller("TagsCtrl",["$scope","$http",function(t,e){t.busy=!0,e({method:"GET",url:host+"/tags",params:{type:"all"}}).success(function(e){t.busy=!1,t.allTags=e})}]),routeApp.controller("UserCommentsCtrl",["$http","$scope",function(t,e){e.deleteBox=!1,e.edit=!1,e.readonly=!0,e.busy=!0,t({method:"GET",url:host+"/comments"}).success(function(t){e.comments=t,e.busy=!1}),e.focus=function(t){t.readonly=!1,t.edit=!0},e.submit=function(e){t({method:"POST",url:host+"/comment",data:{id:e.comment.id}}).success(function(){e.readonly=!0,e.edit=!1})},e["delete"]=function(o,s){t({method:"DELETE",url:host+"/comment",data:{id:o}}).success(function(){e.comments.splice(s,1)})}}]);