var delay=2800,host="http://www.bookist.org",routeApp=angular.module("index",["ui.router","ui.bootstrap","ngAnimate","ngSanitize","ngTouch","infinite-scroll"]);routeApp.config(["$stateProvider","$locationProvider","$httpProvider","$urlRouterProvider",function(t,e,o,s){o.defaults.transformResponse.push(function(t){return"undefined"!=typeof t.data&&"success"==t.status?t=t.data:("error"==t.status&&console.log("----------------Error----------------: "+t.message),t)}),o.interceptors.push("timestampMarker"),o.interceptors.push("tokenInjector"),o.defaults.transformRequest=function(t){var e=[];for(var o in t)e.push(encodeURIComponent(o)+"="+encodeURIComponent(t[o]));return e.join("&")},o.defaults.headers.post={"Content-Type":"application/x-www-form-urlencoded"},o.defaults.headers.put={"Content-Type":"application/x-www-form-urlencoded"},o.defaults.headers["delete"]={"Content-Type":"application/x-www-form-urlencoded"},s.otherwise("/"),t.state("index",{url:"/",templateUrl:"index/index_tpl.html",controller:"IndexCtrl"}).state("recommend",{url:"/books/recommend",controller:"RecommendMoreCtrl",templateUrl:"recommend_more/recommend_more_tpl.html"}).state("booklists",{url:"/booklists",controller:"BooklistsCtrl",templateUrl:"booklists/booklists_tpl.html"}).state("popular",{url:"/booklists/popular",controller:"PopularMoreCtrl",templateUrl:"popular_more/popular_more_tpl.html"}).state("book",{url:"/book/{isbn}",controller:"BookCtrl",templateUrl:"book/book_tpl.html"}).state("bookDetail",{url:"/book/{isbn}/detail",controller:"BookInfoCtrl",templateUrl:"book_info/book_info_tpl.html"}).state("booklist",{url:"/booklist/{id}",controller:"BookListCtrl",templateUrl:"booklist/booklist_tpl.html"}).state("tagBooklists",{url:"/booklists/{tag}",controller:"TagBooklistsCtrl",templateUrl:"tag-booklists/tag-booklists_tpl.html"}).state("commentsBook",{url:"/comments/{isbn}",controller:"CommentsCtrl",templateUrl:"comments/comments_tpl.html"}).state("tags",{url:"/tags",controller:"TagsCtrl",templateUrl:"tags/tags_tpl.html"}).state("me",{url:"/me",controller:"MeCtrl",templateUrl:"me/me_tpl.html"}).state("ordersWait",{url:"/orders/wait",controller:"OrdersWaitCtrl",templateUrl:"orders_wait/orders_wait_tpl.html"}).state("cart",{url:"/cart",controller:"CartCtrl",templateUrl:"cart/cart_tpl.html"}).state("ordersReceived",{url:"/orders/received",controller:"OrdersReceivedCtrl",templateUrl:"orders_received/orders_received_tpl.html"}).state("orders",{url:"/orders",controller:"OrdersCtrl",templateUrl:" app/module/orders/orders_tpl.html"}).state("orderDetail",{url:"/order/{id}/detail",controller:"OrderDetailCtrl",templateUrl:"order_detail/order_detail_tpl.html"}).state("orderComments",{url:"/order/{id}/comments",controller:"OrderCommentsCtrl",templateUrl:"order_comments/order_comments_tpl.html"}).state("comments",{url:"/comments",controller:"UserCommentsCtrl",templateUrl:"user_comments/user_comments_tpl.html"}).state("booklistsCollect",{url:"/collect/booklists",controller:"CollectBookListsCtrl",templateUrl:"collect_booklists/collect_booklists_tpl.html"}).state("booksCollect",{url:"/collect/books",controller:"CollectBooksCtrl",templateUrl:"collect_books/collect_books_tpl.html"}).state("point",{url:"/point",controller:"PointCtrl",templateUrl:"point/point_tpl.html"}).state("notices",{url:"/notices",controller:"NoticesCtrl",templateUrl:"notices/notices_tpl.html"}).state("settings",{url:"/settings",controller:"SettingsCtrl",templateUrl:"settings/settings_tpl.html"}).state("signature",{url:"/setting/signature/{signature}",controller:"SignatureCtrl",templateUrl:"setting_signature/setting_signature_tpl.html"}).state("address",{url:"/setting/address",controller:"AddressCtrl",templateUrl:"setting_address/setting_address_tpl.html"}).state("AddressAdd",{url:"/setting/address/add",controller:"AddressAddCtrl",templateUrl:"setting_address_add/setting_address_add_tpl.html"}).state("cart2order",{url:"/cart2order",controller:"Cart2OrderCtrl",templateUrl:"cart2order/cart2order_tpl.html"}).state("suggest",{url:"/suggest",controller:"SuggestCtrl",templateUrl:"suggest/suggest_tpl.html"})}]),routeApp.directive("currentTime",["$timeout","dateFilter",function(t,e){return{scope:{format:"@",real:"@"},link:function(o,s){function r(){s.text(e(new Date,o.format))}function n(){i=t(function(){r(),n()},1e3)}var i;"true"==o.real||o.real?(s.bind("$destroy",function(){t.cancel(i)}),n()):r()}}}]),routeApp.directive("focusMe",["$timeout",function(t){return{scope:{trigger:"@focusMe"},link:function(e,o){e.$watch("trigger",function(e){"true"===e&&t(function(){o[0].focus()})})}}}]),routeApp.directive("navbar",function(){return{restrict:"AE",replace:!0,templateUrl:"navbar/navbar_tpl.html"}}),routeApp.directive("loading",function(){return{restrict:"AE",replace:!0,template:'<div class="cssload-thecube"><div class="cssload-cube cssload-c1"></div><div class="cssload-cube cssload-c2"></div><div class="cssload-cube cssload-c4"></div><div class="cssload-cube cssload-c3"></div></div>'}}),routeApp.directive("wait",function(){return{restrict:"AE",replace:!0,template:'<div id="circularG"><div id="circularG_1" class="circularG"></div><div id="circularG_2" class="circularG"></div><div id="circularG_3" class="circularG"></div><div id="circularG_4" class="circularG"></div><div id="circularG_5" class="circularG"></div><div id="circularG_6" class="circularG"></div><div id="circularG_7" class="circularG"></div><div id="circularG_8" class="circularG"></div></div>'}}),routeApp.directive("myMaxlength",function(){return{require:"ngModel",link:function(t,e,o,s){function r(t){if(t.length>n){var e=t.substring(0,n);return s.$setViewValue(e),s.$render(),e}return t}var n=Number(o.myMaxlength);s.$parsers.push(r)}}}),routeApp.factory("BL",["$http",function(t){var e=function(t,e){this.list=[],this.busy=!1,this.url=t,this.params=e,this["continue"]=!0};return e.prototype.nextPage=function(){return this["continue"]?void(this.busy||(this.busy=!0,t({method:"GET",url:this.url,params:this.params}).success(function(t){var e=t;e.length<5&&(this["continue"]=!1);for(var o=0;o<e.length;o++)e[o].star=Math.ceil(e[o].rate/2),this.list.push(e[o]);this.busy=!1,this.params.page+=1}.bind(this)))):void(this.busy=!1)},e}]),routeApp.factory("TEMP",function(){var t=[],e={};return{pushList:function(e){t.push(e)},setList:function(e){t=e},getList:function(){return t},setDict:function(t){e=t},getDict:function(){return e}}}),routeApp.factory("User",function(){var t="",e={};return{getSignature:function(){return t},getTemp:function(){return e},setSignature:function(e){t=e},setTemp:function(t){e=t}}}),routeApp.factory("timestampMarker",[function(){var t={request:function(t){return t.requestTimestamp=(new Date).getTime(),t},response:function(t){return t.config.responseTimestamp=(new Date).getTime(),t}};return t}]),routeApp.factory("tokenInjector",["$injector","$q","$location",function(t,e){var o={request:function(o){var s=host+"/auth_verify",r=e.defer(),n=t.get("$http");if(o.url===s)return o;if("true"===sessionStorage.verify){var i=(new Date).getTime()/1e3;i-sessionStorage.createdtime>=7e3&&(sessionStorage.verify=!1),o.headers.token=sessionStorage.token,o.headers.userid=sessionStorage.user_id,r.resolve(o)}else n({method:"GET",url:s,params:{token:sessionStorage.token,user_id:sessionStorage.user_id}}).success(function(t){sessionStorage.token=t.token,sessionStorage.createdtime=t.time,sessionStorage.verify="true",o.headers.token=sessionStorage.token,o.headers.userid=sessionStorage.user_id,console.log("verify OK"),r.resolve(o)}).error(function(){console.log("verify FAIL"),r.resolve(o)});return r.promise}};return o}]),routeApp.filter("nl2br",["$sanitize",function(t){var e=/xhtml/i.test(document.doctype)?"<br />":"<br>";return function(o){return o=(o+"").replace(/(\r\n|\n\r|\r|\n|&#10;&#13;|&#13;&#10;|&#10;|&#13;)/g,e+"$1"),t(o)}}]),routeApp.controller("BookCtrl",["$scope","$http","$stateParams","TEMP",function(t,e,o,s){t.more=!1,t.busy=!0,t.wait=!1,t.wait2=!1,t.wait3=!1,t.wait4=!1,t.wait5=!1,t.wait6=!1,t.wait7=!1,t.required=!0,t.content="",t.star=5,t.addCart=function(){t.wait3=!0,e({method:"POST",url:host+"/cart",data:{isbn:o.isbn}}).success(function(){t.wait3=!1,t.wait4=!0,window.setTimeout(function(){t.$apply(function(){t.wait4=!1})},1500)})},e({method:"GET",url:host+"/book",params:{isbn:o.isbn}}).success(function(e){t.book=e,t.book.star=Math.ceil(e.rate/2);for(var o=0;o<e.comments.length;o++)t.book.comments[o].star=Math.ceil(t.book.comments[o].star/2);s.setDict({title:t.book.title}),t.busy=!1}),e({method:"GET",url:host+"/user_info"}).success(function(e){t.user=e}),t.collect=function(){t.wait2=!0,e({method:"POST",url:host+"/collect",data:{isbn:o.isbn,type:"book"}}).success(function(){t.book.collect_already=!t.book.collect_already,t.wait2=!1,t.book.collect_already?t.wait5=!0:t.wait6=!0,window.setTimeout(function(){t.$apply(function(){t.wait5=!1,t.wait6=!1})},delay)})},e({method:"GET",url:host+"/book",params:{isbn:o.isbn,type:"similarity"}}).success(function(e){t.booksBought=e.books;for(var o=0;o<t.booksBought.length;o++)t.booksBought[o].star=Math.ceil(t.booksBought[o].rate/2)}),e({method:"GET",url:host+"/booklist",params:{isbn:o.isbn}}).success(function(e){t.booklists=e}),t.up=function(t){e({method:"PUT",url:host+"/comment",data:{id:t.id,type:"up"}}).success(function(){t.down_already&&t.down--,t.up_already=!t.up_already,t.down_already=!1,t.up_already?t.up++:t.up--})},t.down=function(t){e({method:"PUT",url:host+"/comment",data:{id:t.id,type:"down"}}).success(function(){t.up_already&&t.up--,t.down_already=!t.down_already,t.up_already=!1,t.down_already?t.down++:t.down--})},t.postComment=function(){this.commentForm.content.$valid&&(t.wait=!0,e({method:"POST",url:host+"/comment",data:{content:t.content,isbn:o.isbn,star:2*t.star}}).success(function(e){t.commentBox=!1,t.wait7=!0,e.user={avatar:t.user.avatar,username:t.user.username},e.star=e.star/2,t.book.commenters++,t.book.comments.push(e),t.wait=!1,t.content="",window.setTimeout(function(){t.$apply(function(){t.wait7=!1})},delay)}))}}]),routeApp.controller("BookListCtrl",["$scope","$http","$stateParams",function(t,e,o){t.busy=!0,t.wait=!1,t.wait1=!1,t.wait2=!1,e({method:"GET",url:host+"/booklist",params:{id:o.id}}).success(function(e){t.booklist=e;for(var o=0;o<t.booklist.books.length;o++)t.booklist.books[o].star=Math.ceil(t.booklist.books[o].rate/2);t.busy=!1}),t.collect=function(){t.wait=!0,e({method:"POST",url:host+"/collect",data:{type:"booklist",id:o.id}}).success(function(){t.booklist.collect_already=!t.booklist.collect_already,t.booklist.collect_already?(t.booklist.collect++,t.wait1=!0):(t.booklist.collect--,t.wait2=!0),t.wait=!1,window.setTimeout(function(){t.$apply(function(){t.wait1=!1,t.wait2=!1})},delay)})}}]),routeApp.controller("BooklistsCtrl",["$scope","$http","BL",function(t,e,o){void 0!=sessionStorage.tags?t.tags=JSON.parse(sessionStorage.tags):e({method:"GET",url:host+"/tags",params:{type:"hot"}}).success(function(e){t.tags=e,sessionStorage.tags=JSON.stringify(t.tags)});var s=host+"/booklist",r={type:"all",page:1};t.booklists=new o(s,r),t.timeOrder=function(){var e=host+"/booklist",s={type:"time",page:1};t.booklists=new o(e,s),t.booklists.nextPage()},t.collectOrder=function(){var e=host+"/booklist",s={type:"collect",page:1};t.booklists=new o(e,s),t.booklists.nextPage()}}]),routeApp.controller("BookInfoCtrl",["$http","$scope","$stateParams",function(t,e,o){e.busy=!0,t({method:"GET",url:host+"/book",params:{isbn:o.isbn,type:"detail"}}).success(function(t){e.book=t,e.busy=!1})}]),routeApp.controller("Cart2OrderCtrl",["$http","$scope","TEMP","$state",function(t,e,o,s){e.wait=!1,e.books=o.getList(),o.setList([]),e.cart_list="",e.order={number:0,price:0};for(var r=0;r<e.books.length;r++)e.order.number+=e.books[r].number,e.order.price+=e.books[r].price*e.books[r].number,r!==e.books.length-1?e.cart_list+=e.books[r].id+",":e.cart_list+=e.books[r].id;t({method:"GET",url:host+"/user_address",params:{type:"default"}}).success(function(t){e.x=t[0]}),e.make=function(){e.wait=!0,t({method:"POST",url:host+"/billing",data:{cart_list:e.cart_list,address_id:e.x.id}}).success(function(t){s.go("orderDetail",{id:t},{location:"orders"}),window.setTimeout(function(){e.$apply(function(){e.wait=!1})},500)})}}]),routeApp.controller("CartCtrl",["$scope","$http","$state","TEMP",function(t,e,o,s){t.price=0,t.busy=!0,t.wait1=!1,t.wait2=!1,t.checked=!1,t.status="",t.editStatu=!1,t.count=0,t.number=0,t.checkArr=[],e({method:"GET",url:host+"/user_carts"}).success(function(e){t.items=e,t.busy=!1;for(var o=0;o<t.items.length;o++)t.items[o].checked=!1,t.items[o].index=o,t.items[o]._index=o,t.items[o].status="";t.recount(t.items)}),t.recount=function(){t.price=0,t.count=0,t.status="active",t.checked=!0,t.number=0;for(var e=0;e<t.items.length;e++)t.price+=t.items[e].price*t.items[e].number*t.items[e].checked,t.count+=t.items[e].number*t.items[e].checked,t.items[e].checked?t.number++:(t.checked=!1,t.status="");0==t.items.length&&(t.message=!0)},t.selectAll=function(){if("active"==t.status){t.status="",t.checked=!1;for(var e=0;e<t.items.length;e++)t.items[e].checked=!1,t.items[e].status="";t.recount()}else{t.status="active",t.checked=!0;for(var o=0;o<t.items.length;o++)t.items[o].checked=!0,t.items[o].status="active";t.recount()}},t.plus=function(e){e.number<10&&(e.number++,t.recount())},t.minus=function(e){e.number>1&&(e.number--,t.recount())},t.edit=function(){for(var e=0;e<t.items.length;e++)t.checkArr[e]=t.items[e].checked,t.items[e].checked=!1,t.items[e].status="";t.recount(),t.editStatu=!0},t.editOk=function(){for(var e=0;e<t.items.length;e++)t.items[e].checked=t.checkArr[e],t.items[e].checked?t.items[e].status="active":t.items[e].status="";t.recount(),t.editStatu=!1},t.select=function(e){"active"==e?(this.item.status="",this.item.checked=!1,t.recount(t.items)):(this.item.status="active",this.item.checked=!0,t.recount(t.items))},t["delete"]=function(){for(var e=0;e<t.items.length;e++)if(t.items[e].checked){t.removeBook(t.items[e]);for(var o=e+1;o<t.items.length;o++)t.items[o]._index--}t.recount()},t.removeBook=function(o){e({method:"DELETE",url:host+"/cart",data:{isbn:o.book.isbn}}).success(function(){t.wait1=!0,t.items.splice(o._index,1),t.checkArr.splice(o.index,1),t.recount(),window.setTimeout(function(){t.$apply(function(){t.wait1=!1})},delay)})},t.collect=function(){for(var e=0;e<t.items.length;e++)if(t.items[e].checked){t.collectBook(t.items[e]),t.removeBook(t.items[e]);for(var o=e+1;o<t.items.length;o++)t.items[o]._index--}},t.collectBook=function(o){console.log(o),e({method:"POST",url:host+"/collect",data:{isbn:o.book.isbn,type:"book"}}).success(function(){t.wait2=!0,window.setTimeout(function(){t.$apply(function(){t.wait2=!1})},delay)})},t.editBook=function(o){o.number<=0&&(o.number=1),o.number>10&&(o.number=10),e({method:"PUT",url:host+"/cart",data:{isbn:o.book.isbn,number:o.number}}).success(function(){t.recount()})},t.cart2order=function(){for(var e=0;e<t.items.length;e++)t.items[e].checked&&s.pushList(t.items[e]);o.go("cart2order")}}]),routeApp.controller("CollectBookListsCtrl",["$http","$scope",function(t,e){e.busy=!0,t({method:"GET",url:host+"/user_collects",params:{type:"booklist"}}).success(function(t){e.booklists=t,e.busy=!1})}]),routeApp.controller("CollectBooksCtrl",["$http","$scope","BL",function(t,e,o){e.busy=!0,t({method:"GET",url:host+"/user_collects",params:{type:"book"}}).success(function(t){e.books=t;for(var o=0;o<e.books.length;o++)e.books[o].star=Math.ceil(e.books[o].rate/2);e.busy=!1}),e.remove=function(o,s){t({method:"POST",url:host+"/collect",data:{isbn:o.isbn,type:"book"}}).success(function(){e.books.splice(s,1)})}}]),routeApp.controller("CommentsCtrl",["$scope","$http","$stateParams","TEMP",function(t,e,o,s){t.busy=!0,t.title=s.getDict().title,e({method:"GET",url:host+"/comments",params:{isbn:o.isbn}}).success(function(e){t.comments=e,t.busy=!1;for(var o=0;o<e.comments.length;o++)t.comments[o].star=Math.ceil(t.comments[o].star/2)}),t.up=function(t){e({method:"PUT",url:host+"/comment",data:{id:t.id,type:"up"}}).success(function(){t.down_already&&t.down--,t.up_already=!t.up_already,t.down_already=!1,t.up_already?t.up++:t.up--})},t.down=function(t){e({method:"PUT",url:host+"/comment",data:{id:t.id,type:"down"}}).success(function(){t.up_already&&t.up--,t.down_already=!t.down_already,t.up_already=!1,t.down_already?t.down++:t.down--})}}]),routeApp.controller("IndexCtrl",["$scope","$http",function(t,e){t.myInterval=5e3,t.noWrapSlides=!1,t.active=0,t.token=sessionStorage.token,t.user_id=sessionStorage.user_id,t.fuck=function(){location.href="http://bookist.org?fuck=true&token="+t.token+"&user_id="+t.user_id+"/"},void 0!=sessionStorage.books?t.books=JSON.parse(sessionStorage.books):e({method:"GET",url:host+"/pop_book"}).success(function(e){t.books=e;for(var o=0;o<t.books.length;o++)t.books[o].star=Math.ceil(t.books[o].rate/2);sessionStorage.books=JSON.stringify(t.books)}),void 0!=sessionStorage.booklists?t.booklists=JSON.parse(sessionStorage.booklists):e({method:"GET",url:host+"/booklist",params:{type:"hot"}}).success(function(e){t.booklists=e,sessionStorage.booklists=JSON.stringify(t.booklists)}),void 0!=sessionStorage.slides?t.slides=JSON.parse(sessionStorage.slides):e({method:"GET",url:host+"/slides"}).success(function(e){t.slides=e,sessionStorage.slides=JSON.stringify(t.slides)})}]),routeApp.controller("MeCtrl",["$scope","$http",function(t,e){void 0!=sessionStorage.user?(t.user=JSON.parse(sessionStorage.user),e({method:"GET",url:host+"/user_info"}).success(function(e){t.user.cart=e.cart_num,t.user.order={wait:0,received:0}})):e({method:"GET",url:host+"/user_info"}).success(function(e){t.user=e,t.user.order={wait:0,received:0},sessionStorage.user=JSON.stringify(e)})}]),routeApp.controller("NoticesCtrl",["$http","$scope",function(t,e){e.busy=!0,t({method:"GET",url:host+"/user_notices"}).success(function(t){e.notices=t,e.busy=!1})}]),routeApp.controller("OrdersCtrl",["$scope","$http",function(t,e){t.message=!1,t.busy=!0,e({method:"GET",url:host+"/user_billings",params:{status:"all"}}).success(function(e){t.orders=e,t.busy=!1}),t.receipt=function(t){e({method:"POST",url:host+"/order",data:{id:t.id}}).success(function(){t.status="待评价"}).error(function(){t.status="待评价"})}}]),routeApp.controller("OrdersWaitCtrl",["$scope","$http",function(t,e){t.busy=!0,e({method:"GET",url:host+"/orders",params:{type:"wait"}}).success(function(e){t.orders=e,t.busy=!1}),t.receipt=function(o,s){e({method:"POST",url:host+"/order",data:{id:o.id}}).success(function(){t.orders.splice(s,1)})}}]),routeApp.controller("OrdersReceivedCtrl",["$scope","$http",function(t,e){t.message=!1,t.busy=!0,e({method:"GET",url:host+"/orders",params:{type:"received"}}).success(function(e){t.orders=e,t.busy=!1})}]),routeApp.controller("OrderCommentsCtrl",["$scope","$http","$stateParams",function(t,e,o){t.busy=!0,e({method:"GET",url:host+"/orders",params:{id:o.id}}).success(function(e){t.order=e,t.busy=!1})}]),routeApp.controller("OrderDetailCtrl",["$scope","$http","$stateParams",function(t,e,o){t.price=0,t.busy=!0,t.status_list=[];var s={create:"创建",pending:"待发货",waiting:"待收货",commenting:"待评价",done:"已完成",canceled:"已取消"};e({method:"GET",url:host+"/billing",params:{id:o.id}}).success(function(e){t.order=e,t.order.status=s[t.order.status];for(var o=0;o<t.order.carts.length;o++)t.price+=t.order.carts[o].number*t.order.carts[o].price;for(var r=0;r<t.order.status_list.length;r++){var n=t.order.status_list[r].split("|");t.status_list.push({status:s[n[0]],time:n[1]})}t.busy=!1}),t.receipt=function(o){e({method:"POST",url:host+"/order",data:{id:o.id}}).success(function(){t.order.process.push({status:"已收货",time:"2015-04-03 12:12:00"}),t.order.status="待评价",t.turn=3}).error(function(){t.order.process.push({status:"已收货",time:"2015-04-03 12:12:00"}),t.order.status="待评价",t.turn=3})}}]),routeApp.controller("PopularMoreCtrl",["$scope","BL",function(t,e){var o=host+"/booklist",s={type:"hot",page:1};t.booklists=new e(o,s)}]),routeApp.controller("PointCtrl",["$http","$scope","BL",function(t,e,o){e.busy=!0,t({method:"GET",url:host+"/user_points"}).success(function(t){e.points=t,e.busy=!1})}]),routeApp.controller("RecommendMoreCtrl",["$scope","BL",function(t,e){var o=host+"/pop_book",s={page:1};t.books=new e(o,s)}]),routeApp.controller("SettingsCtrl",["$http","$scope",function(t,e){e.user=JSON.parse(sessionStorage.user)}]),routeApp.controller("AddressCtrl",["$http","$scope","$state","User",function(t,e,o,s){e.wait=!0,t({method:"GET",url:host+"/user_address"}).success(function(t){e.address=t,e.wait=!1}),e.edit=function(){s.setTemp(this.x),o.go("AddressAdd")},e.back=function(){history.back()}}]),routeApp.controller("SignatureCtrl",["$http","$scope","$stateParams","$location",function(t,e,o,s){e.signature=o.signature,e.post=function(){t({method:"POST",url:host+"/signature",data:{signature:this.signature}}).success(function(){s.path("/settings").replace()})},e["return"]=function(){s.path("/settings").replace()}}]),routeApp.controller("SuggestCtrl",["$http","$scope",function(t,e){e.required=!0,e.wait=!1,e.wait2=!1,void 0!=sessionStorage.user?e.user=JSON.parse(sessionStorage.user):t({method:"GET",url:host+"/user_info"}).success(function(t){e.user=t,sessionStorage.user=JSON.stringify(t)}),e.post=function(){this.suggestBox.suggestion.$invalid||(e.wait=!0,t({method:"POST",url:host+"/user_feedback",data:{content:e.suggestion}}).success(function(){e.wait=!1,e.wait2=!0,window.setTimeout(function(){e.$apply(function(){e.wait2=!1,history.back()})},2e3)}))}}]),routeApp.controller("TagsCtrl",["$scope","$http",function(t,e){t.busy=!0,e({method:"GET",url:host+"/tags",params:{type:"all"}}).success(function(e){t.busy=!1,t.allTags=e})}]),routeApp.controller("AddressAddCtrl",["$http","$scope","$location","$state","User",function(t,e,o,s,r){var n=r.getTemp();e.edit=!1,e.correct_name=!1,e.correct_dorm=!1,e.correct_phone=!1,e.ok1=!1,e.ok2=!1,e.ok3=!1,e.wait1=!1,e.wait2=!1,e.wait3=!1,"{}"!=JSON.stringify(n)&&(e.name=n.name,e.phone=n.phone,e.dorm=n.dormitory,e.id=n.id,e.edit=!0,r.setTemp({})),e.add=function(){this.addressForm.$invalid?(console.log(this.addressForm),this.addressForm.name.$invalid?(e.correct_name=!0,window.setTimeout(function(){e.$apply(function(){e.correct_name=!1})},2500)):this.addressForm.phone.$invalid?(e.correct_phone=!0,window.setTimeout(function(){e.$apply(function(){e.correct_phone=!1})},2500)):this.addressForm.dorm.$invalid&&(e.correct_dorm=!0,window.setTimeout(function(){e.$apply(function(){e.correct_dorm=!1})},2500))):e.edit?(console.log("edit"),e.wait2=!0,t({method:"PUT",url:host+"/user_address",data:{name:e.name,phone:e.phone,dormitory:e.dorm,id:e.id}}).success(function(){e.wait2=!1,e.ok2=!0,window.setTimeout(function(){e.$apply(function(){e.ok2=!1,e.back()})},1e3)})):(console.log("add"),e.wait1=!0,t({method:"POST",url:host+"/user_address",data:{name:e.name,phone:e.phone,dormitory:e.dorm}}).success(function(){e.wait1=!1,e.ok1=!0,window.setTimeout(function(){e.$apply(function(){e.ok1=!1,e.back()})},1e3)}))},e["delete"]=function(o){e.wait3=!0,t({method:"DELETE",url:host+"/user_address",data:{id:o}}).success(function(){e.ok3=!0,e.wait3=!1,window.setTimeout(function(){e.$apply(function(){e.ok3=!1,e.back()})},1e3)})},e.back=function(){history.back()}}]),routeApp.controller("TagBooklistsCtrl",["$scope","BL","$stateParams",function(t,e,o){var s=host+"/booklist",r={tag:o.tag,page:1};t.booklists=new e(s,r),t.timeOrder=function(){var s=host+"/booklist",r={tag:o.tag,page:1,type:"time"};t.booklists=new e(s,r),t.booklists.nextPage()},t.collectOrder=function(){var s=host+"/booklist",r={tag:o.tag,page:1,type:"collect"};t.booklists=new e(s,r),t.booklists.nextPage()}}]),routeApp.controller("UserCommentsCtrl",["$http","$scope",function(t,e){e.deleteBox=!1,e.edit=!1,e.readonly=!0,e.busy=!0,e.wait=!1,e.required=!0,e.wait2=!1,e.wait3=!1,t({method:"GET",url:host+"/user_comments"}).success(function(t){e.comments=t;for(var o=0;o<e.comments.length;o++)e.comments[o].star=Math.ceil(e.comments[o].star/2);e.busy=!1}),e.focus=function(t){t.readonly=!1,t.edit=!0},e.submit=function(e){e.commentForm.content.$valid&&(e.wait=!0,t({method:"PUT",url:host+"/comment",data:{id:e.comment.id,type:"edit",content:e.comment.content,star:2*e.comment.star}}).success(function(){e.wait=!1,e.readonly=!0,e.edit=!1}))},e["delete"]=function(o,s){e.wait2=!0,t({method:"DELETE",url:host+"/comment",data:{id:o}}).success(function(){e.wait2=!1,e.wait3=!0,e.comments.splice(s,1),window.setTimeout(function(){e.$apply(function(){e.wait3=!1})},delay)})}}]);